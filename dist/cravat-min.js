function Cravat(e){this._rootEl=e.root||document.body,this._width=e.width||420,this._height=e.height||420,this._showControls=typeof e.showControls=="undefined"?!0:e.showControls,this._onSnap=e.onSnap,this._onReady=e.onReady||function(){},this._init()}Cravat.i18n={snap:"snap",transforms:"Transforms",transform_standard:"none",transform_rotate4:"rotate4",transform_split4:"split4",transform_hFlip:"hFlip",transform_flipAll:"flipAll",filters:"Filters",filter_standard:"none",filter_bw:"bw",filter_grey3:"grey3",filter_bi:"bi",filter_offset:"offset",filter_invert:"invert",overlays:"Overlays",overlay_standard:"none",overlay_stripes:"stripes",overlay_circle:"circle"},Cravat.prototype._animLoop=function(e,t){function i(s){n!==!1&&(requestAnimFrame(i,t),n=e(s-r),r=s)}var n,r=+(new Date);window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),i(r)},Cravat.prototype._createMarkup=function(){var e='    <div class="cravat">      <div class="frame">        <canvas class="video"></canvas>        <canvas class="overlay"></canvas>        <video style="display:none" autoplay></video>        <div class="count-down"></div>      </div>';this._showControls&&(e+='      <div class="tools">        <button class="snap">'+Cravat.i18n.snap+'</button>        <div class="transforms">          <h2>'+Cravat.i18n.transforms+"</h2>",Object.keys(Cravat.Transformer.prototype.transforms).forEach(function(t){e+='<button data-transform="'+t+'">'+Cravat.i18n["transform_"+t]+"</button>"}),e+='        </div>        <div class="filters">          <h2>'+Cravat.i18n.filters+"</h2>",Object.keys(Cravat.Filterer.prototype.filters).forEach(function(t){e+='<button data-filter="'+t+'">'+Cravat.i18n["filter_"+t]+"</button>"}),e+='        </div>        <div class="overlays">          <h2>'+Cravat.i18n.overlays+"</h2>",Object.keys(Cravat.Overlayer.prototype.overlays).forEach(function(t){e+='<button data-overlay="'+t+'">'+Cravat.i18n["overlay_"+t]+"</button>"}),e+="        </div>      </div>"),e+="    </div>",this._rootEl.innerHTML=e},Cravat.prototype.destroy=function(){this._removeEvents(),this._mediaStream.stop(),this._rootEl.innerHTML=""},Cravat.prototype._init=function(){window.URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getUserMedia){this._createMarkup();var e=this._rootEl.querySelector(".frame");e.style.position="relative",e.style.width=this._width+"px",e.style.height=this._height+"px",this._videoEl=this._rootEl.querySelector("video"),this._videoCanvasEl=this._rootEl.querySelector("canvas.video"),this._videoCtx=this._videoCanvasEl.getContext("2d"),this._overlayCanvasEl=this._rootEl.querySelector("canvas.overlay"),this._overlayCtx=this._overlayCanvasEl.getContext("2d"),this._mediaStream=null,this._videoCanvasEl.style.position="absolute",this._overlayCanvasEl.style.position="absolute",this._videoCanvasEl.width=this._overlayCanvasEl.width=this._width,this._videoCanvasEl.height=this._overlayCanvasEl.height=this._height,this._transformer=new Cravat.Transformer(this._videoEl,this._videoCtx),this._snapper=new Cravat.Snapper(this._videoCanvasEl,this._overlayCanvasEl,this._rootEl,this._onSnap),this._overlayer=new Cravat.Overlayer(this._overlayCtx),this._filterer=new Cravat.Filterer(this._videoCtx),this._addEvents(),navigator.getUserMedia({video:!0},function(e){this._mediaStream=e,this._videoEl.src=window.URL.createObjectURL(this._mediaStream);var t=!1;this._animLoop(function(){this._transformer.transform()&&!t&&(this._onReady(),t=!0),this._videoCtx.putImageData(this._filterer.filter(this._videoCtx.getImageData(0,0,this._width,this._height)),0,0)}.bind(this))}.bind(this),function(e){this._rootEl.innerHTML="Sorry getUserMedia failed with error: "+e}.bind(this))}else this._rootEl.innerHTML="Sorry your browser does not support getUserMedia"},Cravat.prototype._addEvents=function(){this._showControls&&(this._rootEl.querySelector("button.snap").addEventListener("click",function(e){this._snapper.snap()}.bind(this)),[].slice.call(this._rootEl.querySelectorAll(".transforms button")).forEach(function(e){e.addEventListener("click",function(e){this.setTransform(e.target.dataset.transform)}.bind(this))}.bind(this)),[].slice.call(this._rootEl.querySelectorAll(".overlays button")).forEach(function(e){e.addEventListener("click",function(e){this.setOverlay(e.target.dataset.overlay)}.bind(this))}.bind(this)),[].slice.call(this._rootEl.querySelectorAll(".filters button")).forEach(function(e){e.addEventListener("click",function(e){this.setFilter(e.target.dataset.filter)}.bind(this))}.bind(this)))},Cravat.prototype._removeEvents=function(){this._showControls&&(this._rootEl.querySelector("button.snap").removeEventListener("click"),[].slice.call(this._rootEl.querySelectorAll(".transforms button")).forEach(function(e){e.removeEventListener("click")}),[].slice.call(this._rootEl.querySelectorAll(".overlays button")).forEach(function(e){e.removeEventListener("click")}),[].slice.call(this._rootEl.querySelectorAll(".filters button")).forEach(function(e){e.removeEventListener("click")}))},Cravat.prototype.snap=function(){this._snapper.snap()},Cravat.prototype.snapNow=function(){this._snapper.snapNow()},Cravat.prototype.setTransform=function(e){this._transformer.use(e)},Cravat.prototype.setOverlay=function(e){this._overlayer.use(e)},Cravat.prototype.setFilter=function(e){this._filterer.use(e)};Cravat.Transformer=function(e,t){this._video=e,this._ctx=t,this._current="standard"},Cravat.Transformer.prototype.use=function(e){e in this.transforms&&(this._current=e)},Cravat.Transformer.prototype.transform=function(){try{return this.transforms[this._current](this._video,this._ctx),!0}catch(e){return!1}},Cravat.Transformer.prototype.transforms={standard:function(e,t){var n=t.canvas,r=e.videoWidth,i=e.videoHeight,s=n.width,o=n.height,u=r/i,a=s/o;if(u>=a){var f=i*a,l=r/2-f/2;t.drawImage(e,l,0,f,i,0,0,s,o)}else{var c=r/a,h=i/2-c/2;t.drawImage(e,0,h,r,c,0,0,s,o)}},split4:function(e,t){var n=t.canvas,r=e.videoWidth,i=e.videoHeight;t.drawImage(e,r/2,i/2,r/2,i/2,0,0,n.width/2,n.height/2),t.drawImage(e,0,0,r/2,i/2,n.width/2,n.height/2,n.width/2,n.height/2),t.drawImage(e,0,i/2,r/2,i/2,n.width/2,0,n.width/2,n.height/2),t.drawImage(e,r/2,0,r/2,i/2,0,n.height/2,n.width/2,n.height/2)},rotate4:function(e,t){var n=t.canvas,r=e.videoWidth,i=e.videoHeight;t.drawImage(e,0,0,r/2,i/2,0,0,n.width/2,n.height/2),t.save(),t.rotate(Math.PI/2),t.drawImage(e,0,0,r/2,i/2,0,-n.width,n.height/2,n.width/2),t.restore(),t.save(),t.rotate(Math.PI),t.drawImage(e,0,0,r/2,i/2,-n.width,-n.height,n.width/2,n.height/2),t.restore(),t.save(),t.rotate(-Math.PI/2),t.drawImage(e,0,0,r/2,i/2,-n.height,0,n.height/2,n.width/2),t.restore()},hFlip:function(e,t){var n=t.canvas,r=e.videoWidth,i=e.videoHeight;t.drawImage(e,0,0,r/2,i,0,0,n.width/2,n.height),t.save(),t.scale(-1,1),t.drawImage(e,0,0,r/2,i,-n.width,0,n.width/2,n.height),t.restore()},flipAll:function(e,t){var n=t.canvas,r=e.videoWidth,i=e.videoHeight;t.drawImage(e,0,0,r/2,i/2,0,0,n.width/2,n.height/2),t.save(),t.scale(-1,1),t.drawImage(e,0,0,r/2,i/2,-n.width,0,n.width/2,n.height/2),t.restore(),t.save(),t.scale(1,-1),t.drawImage(e,0,0,r/2,i/2,0,-n.height,n.width/2,n.height/2),t.restore(),t.save(),t.scale(-1,-1),t.drawImage(e,0,0,r/2,i/2,-n.width,-n.height,n.width/2,n.height/2),t.restore()}};Cravat.Snapper=function(e,t,n,r){this._countDownEl=n.querySelector("div.count-down"),this._canvas=e,this._overlay=t,this._onSnap=r},Cravat.Snapper.prototype._showStep=function(e){this._countDownEl.className="",this._countDownEl.innerHTML="<span>"+e+"</span>",this._countDownEl.className="count-down fade"},Cravat.Snapper.prototype.snap=function(){this._showStep(3);var e=2;this._snapInterval=setInterval(function(){e===0?(clearInterval(this._snapInterval),this.snapNow(),this._countDownEl.innerHTML=""):(this._showStep(e),e--)}.bind(this),1e3)},Cravat.Snapper.prototype.snapNow=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=this._canvas.width,e.height=this._canvas.height,t.drawImage(this._canvas,0,0,this._canvas.width,this._canvas.height),t.drawImage(this._overlay,0,0,this._canvas.width,this._canvas.height),this._onSnap?this._onSnap(e.toDataURL("image/png")):document.location.href=e.toDataURL("image/png").replace("image/png","image/octet-stream")};Cravat.Overlayer=function(e){this._current="standard",this.ctx=e},Cravat.Overlayer.prototype.use=function(e){e in this.overlays&&(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.overlays[e](this.ctx))},Cravat.Overlayer.prototype.overlays={standard:function(e){},stripes:function(e){e.save(),e.fillStyle="white",e.translate(e.canvas.width,-e.canvas.height),e.rotate(Math.PI/4);for(var t=0;t<e.canvas.width*2;t+=5)e.fillRect(t,0,3,e.canvas.height*3);e.restore()},circle:function(e){var t=e.canvas.width,n=e.canvas.height,r=Math.min(t,n)/2-15,i=t/2-r,s=n/2-r;e.save(),e.fillStyle="white",e.beginPath(),e.moveTo(0,0),e.lineTo(t/2,0),e.lineTo(t/2,s),e.arcTo(i,s,i,n/2,r),e.lineTo(0,n/2),e.lineTo(0,0),e.fill(),e.closePath(),e.beginPath(),e.moveTo(t/2,0),e.lineTo(t,0),e.lineTo(t,n/2),e.lineTo(i+2*r,n/2),e.arcTo(i+2*r,s,t/2,s,r),e.lineTo(t/2,0),e.fill(),e.closePath(),e.beginPath(),e.moveTo(t,n/2),e.lineTo(i+2*r,n/2),e.arcTo(i+2*r,s+2*r,t/2,s+2*r,r),e.lineTo(t/2,n),e.lineTo(t,n),e.lineTo(t,n/2),e.fill(),e.closePath(),e.beginPath(),e.moveTo(t/2,n),e.lineTo(t/2,s+2*r),e.arcTo(i,s+2*r,i,n/2,r),e.lineTo(0,n/2),e.lineTo(0,n),e.lineTo(t/2,n),e.fill(),e.closePath(),e.restore()}};Cravat.Filterer=function(e){this._current="standard"},Cravat.Filterer.prototype.use=function(e){e in this.filters&&(this._current=e)},Cravat.Filterer.prototype.filter=function(e){var t=e.data.length;for(var n=0;n<t;n+=4)rgba=this.filters[this._current](e.data[n],e.data[n+1],e.data[n+2],e.data[n+3],n,t),e.data[n]=rgba[0],e.data[n+1]=rgba[1],e.data[n+2]=rgba[2],e.data[n+3]=rgba[3];return e},Cravat.Filterer.prototype.filters={standard:function(e,t,n,r,i,s){return[e,t,n,r]},bw:function(e,t,n,r,i,s){var o=Math.floor(e*.3+t*.59+n*.11);return e=t=n=o,r=255,[e,t,n,r]},grey3:function(e,t,n,r,i,s){var o=100,u=30;return e>o&&t>o&&n>o?[200,200,200,255]:e<=o&&e>u&&t<=o&&t>u&&n<=o&&n>u?[150,150,150,255]:[100,100,100,255]},bi:function(e,t,n,r,i,s){var o=100;return e>o&&t>o&&n>o?[255,255,255,255]:[255,0,0,255]},offset:function(e,t,n,r,i,s){return[n,t,e,r]},invert:function(e,t,n,r,i,s){return[255-e,255-t,255-n,r]}};